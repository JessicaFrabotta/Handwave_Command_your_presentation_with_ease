<!DOCTYPE html>
<html>
<head>
  <title>Wio Terminal Control</title>
  <!-- Head section with title and styles -->
  <style>
    /* Styling for the body */
    body {
      position: relative;
    }
    /* Styling for the presentation iframe */
    #presentation-iframe {
      width: 100%;
      height: 97vh;
    }
    /* Styling for the banner */
    #banner {
      position: absolute;
      top: 30vh;
      width: 27%;
    }
    /* Styling for the feed */
    #feed {
        display: none;
    }
  </style>

  <!-- Script to adjust the height of the presentation iframe based on fullscreen changes -->
  <script>
    document.addEventListener("fullscreenchange", function () {
      var presentationIframe = document.getElementById("presentation-iframe");
      if (document.fullscreenElement) {
        presentationIframe.style.height = "97%";
      } else {
        presentationIframe.style.height = "97vh";
      }
    });
  </script>

  <!-- Script to detect the type of browser being used -->
  <script>
    function getBrowserType() {
      const test = regexp => {
        return regexp.test(navigator.userAgent);
      };

      if (test(/opr\//i) || !!window.opr) {
        return 'Opera';
      } else if (test(/edg/i)) {
        return 'Microsoft Edge';
      } else if (test(/chrome|chromium|crios/i)) {
        return 'Google Chrome';
      } else if (test(/firefox|fxios/i)) {
        return 'Mozilla Firefox';
      } else if (test(/safari/i)) {
        return 'Apple Safari';
      } else if (test(/trident/i)) {
        return 'Microsoft Internet Explorer';
      } else if (test(/ucbrowser/i)) {
        return 'UC Browser';
      } else if (test(/samsungbrowser/i)) {
        return 'Samsung Browser';
      } else {
        return 'Unknown browser';
      }
    }
    // Get browser type and display it in an HTML element
    const browserType = getBrowserType();
    const browserTypeElement = document.getElementById('browser-type');
    browserTypeElement.innerHTML = browserType;


  </script>

  <!-- Script to periodically fetch and send screen size information to the server -->
  <script>
    function get_size() {
      // Function to retrieve and send screen size information
      let screenHeight = window.screen.height;
      let screenWidth = window.screen.width;
      let w = window.outerWidth;
      let h = window.outerHeight;
      let width = window.innerWidth;
      let height = window.innerHeight;

      // Fetch and send screen size information using multiple POST requests
      fetch('/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ w }),
      });

      fetch('/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ h }),
      });

      fetch('/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ height }),
      });

      fetch('/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ width }),
      });

      fetch('/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ screenHeight }),
      });

      fetch('/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ screenWidth }),
      });

      return [screenHeight, screenWidth, h, w, height, width];
    }

    const interval = 5000; // Set interval for periodic screen size updates
    setInterval(get_size, interval);
  </script>
</head>

<body>
  <!-- Script to periodically update the visibility of the tutorial banner based on server response -->
  <script>
    function updateTutorialStatus() {
      var xhr = new XMLHttpRequest();
      xhr.onreadystatechange = function () {
        if (xhr.readyState === 4 && xhr.status === 200) {
          var data = JSON.parse(xhr.responseText);
          var tutorialStatus = data.tutorial_activated_wio;
          var banner = document.getElementById('banner');

          // Toggle banner visibility based on server response
          if (tutorialStatus) {
            banner.style.display = 'none';
          } else {
            banner.style.display = 'block';
          }
        }
      };
      xhr.open('GET', '/get_tutorial_status_wio', true);
      xhr.send();
    }

    setInterval(updateTutorialStatus, 200); // Set interval for periodic tutorial status updates
  </script>
  <!-- Conditional rendering of the tutorial banner based on tutorial_activated_wio variable -->
  {% if tutorial_activated_wio %}
  <img id="banner" src="{{url_for('static', filename='tutorial_banner_wio.png')}}" style="display: none;">
  {% endif %}
  <!-- Presentation iframe and feed elements -->
  <iframe id="presentation-iframe" src="{{ presentation_url }}"></iframe>
  <img id="feed" src="{{ url_for('wio_control_page', presentation_url=presentation_url) }}">

  <!-- Script for handling visibility changes and window resize -->
  <script>
    var value_to_pass = "true";
    var isFirstTime = true;
    var isFirstResize = true;
    var [screenHeight, screenWidth, h, w, height, width] = get_size();

    // Function to navigate to the home page on visibility change
    function backToHomeVisibilityChange() {
      var url = "{{ url_for('home') }}" + "?value_to_pass=" + encodeURIComponent(value_to_pass);
      window.location.href = url;
    }

    // Function to navigate to the home page
    function backToHome() {
      var url = "{{ url_for('home') }}";
      window.location.href = url;
    }

    if (browserType === "Apple Safari" && (screenHeight !== h || screenWidth !== w)) {
      document.addEventListener('visibilitychange', function () {
        if (document.hidden) {
          if (!isFirstTime) {
            backToHomeVisibilityChange();
          } else {
            isFirstTime = false;
          }
        }
      }, false);
    } else {

      document.addEventListener('visibilitychange', function () {
        if (document.hidden) {
          backToHomeVisibilityChange();
        }
      }, false);

    }
    
    window.addEventListener('resize', function () {
      var newWindowHeight = window.innerHeight;
      if (newWindowHeight < height) {
        backToHome();
      }
      height = newWindowHeight;
    });

  </script>
</body>

</html>

